<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="bi bi-list"></i>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-logo">
        <i class="bi bi-mortarboard-fill"></i>
        <h1>AI Study Buddy</h1>
    </a>

    <nav class="sidebar-nav">
        <div class="nav-section-title">Studio</div>
        <a href="spiegazioni.html" class="nav-item">
            <i class="bi bi-chat-dots"></i>
            <span>Spiegazioni AI</span>
        </a>
        <a href="quiz.html" class="nav-item">
            <i class="bi bi-patch-question"></i>
            <span>Quiz</span>
        </a>
        <a href="flashcards.html" class="nav-item active">
            <i class="bi bi-stack"></i>
            <span>Flashcards</span>
        </a>
    </nav>

    <div class="sidebar-footer">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">MC</div>
            <div class="user-details">
                <div class="user-name" id="userName">Mario Calipari</div>
                <div class="user-level">Livello 5</div>
            </div>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- View: Deck List -->
    <div id="deckListView">
        <div class="page-header d-flex justify-content-between align-items-start">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-stack text-primary me-2"></i>
                    I miei Deck
                </h1>
                <p class="page-subtitle">Gestisci e studia le tue flashcards</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline" onclick="openGenerateModal()">
                    <i class="bi bi-magic me-1"></i>
                    Genera con AI
                </button>
                <button class="btn btn-primary" onclick="openCreateDeckModal()">
                    <i class="bi bi-plus-lg me-1"></i>
                    Nuovo Deck
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Stats Row -->
        <div class="row mb-4" id="statsRow">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="card-icon primary"><i class="bi bi-collection"></i></div>
                    <div>
                        <div class="stat-value" id="totalDecks">0</div>
                        <div class="stat-label">Deck totali</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="card-icon warning"><i class="bi bi-card-text"></i></div>
                    <div>
                        <div class="stat-value" id="totalCards">0</div>
                        <div class="stat-label">Flashcards</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="card-icon success"><i class="bi bi-trophy"></i></div>
                    <div>
                        <div class="stat-value" id="totalMastered">0</div>
                        <div class="stat-label">Padroneggiate</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="card-icon primary"><i class="bi bi-lightning"></i></div>
                    <div>
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">Sessioni studio</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Deck Grid -->
        <div class="deck-grid" id="deckGrid">
            <!-- Decks will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state d-none">
            <div class="empty-state-icon">
                <i class="bi bi-stack"></i>
            </div>
            <h3 class="empty-state-title">Nessun deck ancora</h3>
            <p class="empty-state-text">Crea il tuo primo deck o generane uno con l'AI!</p>
            <button class="btn btn-primary" onclick="openCreateDeckModal()">
                <i class="bi bi-plus-lg me-1"></i>
                Crea Deck
            </button>
        </div>
    </div>

    <!-- View: Study Mode -->
    <div id="studyView" class="d-none">
        <div class="page-header">
            <button class="btn btn-outline mb-3" onclick="exitStudyMode()">
                <i class="bi bi-arrow-left me-1"></i>
                Torna ai deck
            </button>
            <h1 class="page-title" id="studyDeckTitle">Studio: Nome Deck</h1>
        </div>

        <div class="flashcard-study-container">
            <div class="flashcard-progress">
                <span id="cardProgress">Carta 1 di 10</span>
            </div>

            <div class="flashcard-wrapper">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-face flashcard-front">
                        <div class="flashcard-label">Domanda</div>
                        <div class="flashcard-content" id="cardFront">
                            Caricamento...
                        </div>
                        <div class="flashcard-hint">Clicca per girare</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="flashcard-label">Risposta</div>
                        <div class="flashcard-content" id="cardBack">
                            Risposta
                        </div>
                    </div>
                </div>
            </div>

            <div class="flashcard-controls">
                <button class="btn btn-danger btn-lg" onclick="markCard(false)">
                    <i class="bi bi-x-lg me-1"></i>
                    Non la so
                </button>
                <button class="btn btn-success btn-lg" onclick="markCard(true)">
                    <i class="bi bi-check-lg me-1"></i>
                    La so!
                </button>
            </div>
        </div>

        <!-- Study Results -->
        <div id="studyResults" class="d-none">
            <div class="quiz-question-card">
                <div class="quiz-result">
                    <div class="quiz-result-score" id="studyScore">0%</div>
                    <div class="quiz-result-label">Sessione completata!</div>

                    <div class="row justify-content-center mb-4">
                        <div class="col-auto">
                            <div class="stat-card">
                                <div class="card-icon success"><i class="bi bi-check-lg"></i></div>
                                <div>
                                    <div class="stat-value text-success" id="studyCorrect">0</div>
                                    <div class="stat-label">Corrette</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="stat-card">
                                <div class="card-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger-color);">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                                <div>
                                    <div class="stat-value text-danger" id="studyIncorrect">0</div>
                                    <div class="stat-label">Da ripassare</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-outline" onclick="exitStudyMode()">
                            <i class="bi bi-arrow-left me-1"></i>
                            Torna ai deck
                        </button>
                        <button class="btn btn-primary" onclick="restartStudy()">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            Studia ancora
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal: Create Deck -->
<div class="modal-overlay" id="createDeckModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Nuovo Deck</h3>
            <button class="modal-close" onclick="closeModal('createDeckModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Nome del Deck *</label>
                <input type="text" class="form-control" id="deckName" placeholder="es. Biologia Cellulare">
            </div>
            <div class="form-group">
                <label class="form-label">Descrizione</label>
                <textarea class="form-control" id="deckDescription" rows="2" placeholder="Descrivi il contenuto del deck"></textarea>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">Materia</label>
                        <input type="text" class="form-control" id="deckSubject" placeholder="es. Biologia">
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">Colore</label>
                        <select class="form-control form-select" id="deckColor">
                            <option value="#6366f1">Viola</option>
                            <option value="#10b981">Verde</option>
                            <option value="#f59e0b">Arancione</option>
                            <option value="#ef4444">Rosso</option>
                            <option value="#3b82f6">Blu</option>
                            <option value="#ec4899">Rosa</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createDeckModal')">Annulla</button>
            <button class="btn btn-primary" onclick="createDeck()">
                <i class="bi bi-plus-lg me-1"></i>
                Crea Deck
            </button>
        </div>
    </div>
</div>

<!-- Modal: Generate Flashcards with AI -->
<div class="modal-overlay" id="generateModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="bi bi-magic me-2"></i>
                Genera Flashcards con AI
            </h3>
            <button class="modal-close" onclick="closeModal('generateModal')">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Seleziona Deck *</label>
                <select class="form-control form-select" id="generateDeckSelect">
                    <option value="">-- Seleziona un deck --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Argomento *</label>
                <input type="text" class="form-control" id="generateTopic" placeholder="es. Mitosi e Meiosi">
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">Numero carte</label>
                        <select class="form-control form-select" id="generateCount">
                            <option value="5" selected>5 carte</option>
                            <option value="10">10 carte</option>
                            <option value="15">15 carte</option>
                            <option value="20">20 carte</option>
                        </select>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label class="form-label">Difficolt√†</label>
                        <select class="form-control form-select" id="generateDifficulty">
                            <option value="EASY">Facile</option>
                            <option value="MEDIUM" selected>Media</option>
                            <option value="HARD">Difficile</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('generateModal')">Annulla</button>
            <button class="btn btn-primary" id="generateBtn" onclick="generateFlashcards()">
                <span id="generateBtnText"><i class="bi bi-magic me-1"></i> Genera</span>
                <span id="generateBtnSpinner" class="d-none">
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        Generazione...
                    </span>
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
    // State
    let decks = [];
    let currentDeck = null;
    let studyCards = [];
    let currentCardIndex = 0;
    let studyResults = { correct: 0, incorrect: 0 };

    // Colors for deck icons
    const deckColors = {
        '#6366f1': 'primary',
        '#10b981': 'success',
        '#f59e0b': 'warning',
        '#ef4444': 'danger',
        '#3b82f6': 'info',
        '#ec4899': 'pink'
    };

    // Load decks on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadDecks();
        loadStats();
    });

    // Load all decks
    async function loadDecks() {
        try {
            const response = await apiFetch('/flashcards/decks');
            if (response.ok) {
                decks = await response.json();
                renderDecks();
                updateDeckSelect();
            }
        } catch (error) {
            console.error('Error loading decks:', error);
        }
    }

    // Load global stats
    async function loadStats() {
        try {
            const response = await apiFetch('/flashcards/decks/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('totalDecks').textContent = stats.totalDecks;
                document.getElementById('totalCards').textContent = stats.totalCards;
                document.getElementById('totalMastered').textContent = stats.totalMastered;
                document.getElementById('totalSessions').textContent = stats.totalStudySessions;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Render decks grid
    function renderDecks() {
        const grid = document.getElementById('deckGrid');
        const emptyState = document.getElementById('emptyState');

        if (decks.length === 0) {
            grid.classList.add('d-none');
            emptyState.classList.remove('d-none');
            return;
        }

        grid.classList.remove('d-none');
        emptyState.classList.add('d-none');

        grid.innerHTML = decks.map(deck => `
            <div class="deck-card" onclick="openDeck('${deck.id}')">
                <div class="deck-header">
                    <div class="deck-icon" style="background: ${deck.color}20; color: ${deck.color}">
                        <i class="bi bi-stack"></i>
                    </div>
                    <div class="deck-info">
                        <div class="deck-name">${deck.name}</div>
                        <div class="deck-subject">${deck.subject || 'Nessuna materia'}</div>
                    </div>
                </div>
                <div class="deck-body">
                    <div class="deck-stats">
                        <div class="deck-stat">
                            <i class="bi bi-card-text"></i>
                            ${deck.totalCards} carte
                        </div>
                        <div class="deck-stat">
                            <i class="bi bi-trophy"></i>
                            ${deck.cardsMastered} padroneggiate
                        </div>
                    </div>
                </div>
                <div class="deck-footer">
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); startStudy('${deck.id}')">
                        <i class="bi bi-play-fill"></i> Studia
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); deleteDeck('${deck.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Update deck select in generate modal
    function updateDeckSelect() {
        const select = document.getElementById('generateDeckSelect');
        select.innerHTML = '<option value="">-- Seleziona un deck --</option>' +
            decks.map(deck => `<option value="${deck.id}">${deck.name}</option>`).join('');
    }

    // Modal functions
    function openModal(id) {
        document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function openCreateDeckModal() {
        document.getElementById('deckName').value = '';
        document.getElementById('deckDescription').value = '';
        document.getElementById('deckSubject').value = '';
        openModal('createDeckModal');
    }

    function openGenerateModal() {
        openModal('generateModal');
    }

    // Create new deck
    async function createDeck() {
        const name = document.getElementById('deckName').value.trim();
        const description = document.getElementById('deckDescription').value.trim();
        const subject = document.getElementById('deckSubject').value.trim();
        const color = document.getElementById('deckColor').value;

        if (!name) {
            showAlert('Inserisci un nome per il deck', 'error');
            return;
        }

        try {
            const response = await apiFetch('/flashcards/decks', {
                method: 'POST',
                body: JSON.stringify({ name, description, subject, color, isPublic: false })
            });

            if (response.ok) {
                closeModal('createDeckModal');
                showAlert('Deck creato con successo!', 'success');
                loadDecks();
                loadStats();
            } else {
                const error = await response.text();
                showAlert(getErrorMessage(error), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Errore nella creazione del deck', 'error');
        }
    }

    // Delete deck
    async function deleteDeck(deckId) {
        if (!confirm('Sei sicuro di voler eliminare questo deck?')) return;

        try {
            const response = await apiFetch(`/flashcards/decks/${deckId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showAlert('Deck eliminato', 'success');
                loadDecks();
                loadStats();
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Errore nell\'eliminazione', 'error');
        }
    }

    // Generate flashcards with AI
    async function generateFlashcards() {
        const deckId = document.getElementById('generateDeckSelect').value;
        const topic = document.getElementById('generateTopic').value.trim();
        const count = document.getElementById('generateCount').value;
        const difficulty = document.getElementById('generateDifficulty').value;

        if (!deckId || !topic) {
            showAlert('Seleziona un deck e inserisci un argomento', 'error');
            return;
        }

        const btn = document.getElementById('generateBtn');
        const btnText = document.getElementById('generateBtnText');
        const btnSpinner = document.getElementById('generateBtnSpinner');

        btn.disabled = true;
        btnText.classList.add('d-none');
        btnSpinner.classList.remove('d-none');

        try {
            const response = await apiFetch(
                `/ai/flashcards/generate?deckId=${deckId}&topic=${encodeURIComponent(topic)}&numberOfCards=${count}&difficulty=${difficulty}`,
                { method: 'POST' }
            );

            if (response.ok) {
                const result = await response.json();
                closeModal('generateModal');
                showAlert(`${result.message} flashcards generate!`, 'success');
                loadDecks();
                loadStats();
            } else {
                const error = await response.text();
                showAlert(getErrorMessage(error), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Errore nella generazione', 'error');
        } finally {
            btn.disabled = false;
            btnText.classList.remove('d-none');
            btnSpinner.classList.add('d-none');
        }
    }

    // Open deck (view cards - for future implementation)
    function openDeck(deckId) {
        startStudy(deckId);
    }

    // Start study session
    async function startStudy(deckId) {
        try {
            const response = await apiFetch(`/flashcards/decks/${deckId}/study-session?numberOfCards=10`);
            if (response.ok) {
                studyCards = await response.json();

                if (studyCards.length === 0) {
                    showAlert('Questo deck non ha ancora flashcards', 'error');
                    return;
                }

                currentDeck = decks.find(d => d.id === deckId);
                currentCardIndex = 0;
                studyResults = { correct: 0, incorrect: 0 };

                document.getElementById('studyDeckTitle').textContent = `Studio: ${currentDeck.name}`;
                document.getElementById('deckListView').classList.add('d-none');
                document.getElementById('studyView').classList.remove('d-none');
                document.getElementById('studyResults').classList.add('d-none');

                renderCard();

                // Record study session
                await apiFetch(`/flashcards/decks/${deckId}/study`, { method: 'POST' });
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Errore nel caricamento delle carte', 'error');
        }
    }

    // Render current card
    function renderCard() {
        const card = studyCards[currentCardIndex];
        document.getElementById('cardFront').textContent = card.frontContent;
        document.getElementById('cardBack').textContent = card.backContent;
        document.getElementById('cardProgress').textContent = `Carta ${currentCardIndex + 1} di ${studyCards.length}`;

        // Reset flip
        document.getElementById('flashcard').classList.remove('flipped');
    }

    // Flip card
    function flipCard() {
        document.getElementById('flashcard').classList.toggle('flipped');
    }

    // Mark card
    async function markCard(wasCorrect) {
        const card = studyCards[currentCardIndex];

        // Record review
        try {
            await apiFetch(`/flashcards/cards/${card.id}/review`, {
                method: 'POST',
                body: JSON.stringify({ wasCorrect })
            });
        } catch (error) {
            console.error('Error recording review:', error);
        }

        // Update results
        if (wasCorrect) {
            studyResults.correct++;
        } else {
            studyResults.incorrect++;
        }

        // Next card or finish
        if (currentCardIndex < studyCards.length - 1) {
            currentCardIndex++;
            renderCard();
        } else {
            finishStudy();
        }
    }

    // Finish study session
    function finishStudy() {
        const total = studyResults.correct + studyResults.incorrect;
        const percentage = Math.round((studyResults.correct / total) * 100);

        document.getElementById('studyScore').textContent = `${percentage}%`;
        document.getElementById('studyCorrect').textContent = studyResults.correct;
        document.getElementById('studyIncorrect').textContent = studyResults.incorrect;

        document.querySelector('.flashcard-wrapper').classList.add('d-none');
        document.querySelector('.flashcard-controls').classList.add('d-none');
        document.querySelector('.flashcard-progress').classList.add('d-none');
        document.getElementById('studyResults').classList.remove('d-none');
    }

    // Restart study
    function restartStudy() {
        currentCardIndex = 0;
        studyResults = { correct: 0, incorrect: 0 };

        document.querySelector('.flashcard-wrapper').classList.remove('d-none');
        document.querySelector('.flashcard-controls').classList.remove('d-none');
        document.querySelector('.flashcard-progress').classList.remove('d-none');
        document.getElementById('studyResults').classList.add('d-none');

        renderCard();
    }

    // Exit study mode
    function exitStudyMode() {
        document.getElementById('studyView').classList.add('d-none');
        document.getElementById('deckListView').classList.remove('d-none');

        // Reset visibility
        document.querySelector('.flashcard-wrapper').classList.remove('d-none');
        document.querySelector('.flashcard-controls').classList.remove('d-none');
        document.querySelector('.flashcard-progress').classList.remove('d-none');

        loadStats();
    }
</script>
</body>
</html>