<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .profile-header {
            background: var(--gradient-primary);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            position: relative;
            overflow: hidden;
        }
        .profile-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        .avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: var(--primary-color);
            font-weight: 700;
            flex-shrink: 0;
            border: 4px solid rgba(255,255,255,0.3);
            position: relative;
        }
        .level-badge-large {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color);
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            border: 3px solid #ffffff;
        }
        .profile-info { flex: 1; min-width: 200px; }
        .profile-name { font-size: 1.75rem; font-weight: 700; color: #ffffff; margin-bottom: 0.25rem; }
        .profile-email { color: rgba(255,255,255,0.8); margin-bottom: 0.75rem; }
        .profile-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.9rem; color: rgba(255,255,255,0.9); }
        .profile-meta i { margin-right: 0.4rem; }
        .profile-xp { text-align: center; padding: 1rem 2rem; background: rgba(255,255,255,0.15); border-radius: 1rem; }
        .profile-xp-value { font-size: 2.5rem; font-weight: 700; color: #ffffff; line-height: 1; }
        .profile-xp-label { color: rgba(255,255,255,0.8); font-size: 0.85rem; }

        .xp-progress-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .xp-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .xp-level { font-weight: 700; color: var(--primary-color); }
        .xp-values { color: var(--text-muted); font-size: 0.875rem; }
        .xp-bar { height: 12px; background: var(--dark-border); border-radius: 6px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--gradient-primary); border-radius: 6px; transition: width 1s ease; }
        .xp-remaining { text-align: center; margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card-profile {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .stat-card-profile:hover { border-color: var(--primary-color); transform: translateY(-4px); }
        .stat-card-profile .stat-icon {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; margin: 0 auto 0.75rem; color: #ffffff;
        }
        .stat-card-profile .stat-icon.purple { background: var(--primary-color); }
        .stat-card-profile .stat-icon.red { background: #dc2626; }
        .stat-card-profile .stat-icon.blue { background: #3b82f6; }
        .stat-card-profile .stat-icon.green { background: #16a34a; }
        .stat-card-profile .stat-icon.yellow { background: #ca8a04; }
        .stat-card-profile .stat-icon.pink { background: #db2777; }
        .stat-card-profile .stat-value { font-size: 1.75rem; font-weight: 700; color: #ffffff; line-height: 1; }
        .stat-card-profile .stat-label { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; color: #ffffff; display: flex; align-items: center; gap: 0.5rem; }
        .section-subtitle { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; }

        .badges-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .badge-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .badge-card:hover { transform: translateY(-4px); border-color: var(--primary-color); }
        .badge-card.unlocked { border-color: var(--accent-color); }
        .badge-card.locked { opacity: 0.5; }
        .badge-icon-container {
            width: 70px; height: 70px; border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.75rem; color: #ffffff;
        }
        .badge-name { font-weight: 700; font-size: 0.9rem; color: #ffffff; margin-bottom: 0.25rem; }
        .badge-description { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; line-height: 1.4; }
        .badge-progress { margin-top: 0.5rem; }
        .badge-progress-bar { height: 6px; background: var(--dark-border); border-radius: 3px; overflow: hidden; }
        .badge-progress-fill { height: 100%; background: var(--primary-color); border-radius: 3px; }
        .badge-progress-text { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }

        .recommendation-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-left: 4px solid var(--primary-color);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }
        .recommendation-card:hover { border-color: var(--primary-color); transform: translateX(4px); }
        .recommendation-content { display: flex; align-items: flex-start; gap: 1rem; flex: 1; }
        .recommendation-icon {
            width: 40px; height: 40px; border-radius: 10px;
            background: rgba(139, 92, 246, 0.2);
            display: flex; align-items: center; justify-content: center;
            color: var(--primary-color); flex-shrink: 0;
        }
        .recommendation-text h4 { font-size: 0.95rem; font-weight: 600; color: #ffffff; margin-bottom: 0.25rem; }
        .recommendation-text p { font-size: 0.8rem; color: var(--text-muted); margin: 0; }
        .recommendation-actions { display: flex; gap: 0.5rem; }
        .recommendation-actions .btn { padding: 0.4rem 0.6rem; font-size: 0.8rem; }

        .empty-recommendations {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
        }
        .empty-recommendations i { font-size: 3rem; color: var(--secondary-color); margin-bottom: 1rem; display: block; }

        .streak-fire { animation: fire-flicker 0.5s ease infinite alternate; }
        @keyframes fire-flicker { from { transform: scale(1); } to { transform: scale(1.15); } }

        @media (max-width: 768px) {
            .profile-header { flex-direction: column; text-align: center; }
            .profile-meta { justify-content: center; }
            .profile-xp { width: 100%; }
            .badges-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
<!-- Sidebar generata da layout.js -->

<main class="main-content">
    <div id="alertContainer"></div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="avatar-large" id="profileAvatar">
            <span id="profileInitials">...</span>
            <div class="level-badge-large" id="levelBadge">1</div>
        </div>
        <div class="profile-info">
            <h1 class="profile-name" id="profileName">...</h1>
            <p class="profile-email" id="profileEmail">...</p>
            <div class="profile-meta">
                <span><i class="bi bi-calendar3"></i> Membro da <span id="memberSince">-</span></span>
                <span><i class="bi bi-fire streak-fire"></i> Streak: <strong id="currentStreak">0</strong> giorni</span>
            </div>
        </div>
        <div class="profile-xp">
            <div class="profile-xp-value" id="totalXp">0</div>
            <div class="profile-xp-label">XP Totali</div>
        </div>
    </div>

    <!-- XP Progress -->
    <div class="xp-progress-card">
        <div class="xp-progress-header">
            <span class="xp-level"><i class="bi bi-star-fill"></i> Livello <span id="currentLevel">1</span></span>
            <span class="xp-values"><span id="currentXpInLevel">0</span> / <span id="xpForNextLevel">100</span> XP</span>
        </div>
        <div class="xp-bar">
            <div class="xp-fill" id="xpProgressBar" style="width: 0%"></div>
        </div>
        <div class="xp-remaining">
            <i class="bi bi-lightning-charge"></i> <span id="xpToNextLevel">100</span> XP per il prossimo livello
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card-profile">
            <div class="stat-icon purple"><i class="bi bi-lightning-charge-fill"></i></div>
            <div class="stat-value" id="weeklyXp">0</div>
            <div class="stat-label">XP Settimana</div>
        </div>
        <div class="stat-card-profile">
            <div class="stat-icon red"><i class="bi bi-fire"></i></div>
            <div class="stat-value" id="longestStreak">0</div>
            <div class="stat-label">Streak Record</div>
        </div>
        <div class="stat-card-profile">
            <div class="stat-icon blue"><i class="bi bi-lightbulb-fill"></i></div>
            <div class="stat-value" id="explanationsCount">0</div>
            <div class="stat-label">Spiegazioni</div>
        </div>
        <div class="stat-card-profile">
            <div class="stat-icon green"><i class="bi bi-patch-check-fill"></i></div>
            <div class="stat-value" id="quizzesCompleted">0</div>
            <div class="stat-label">Quiz</div>
        </div>
        <div class="stat-card-profile">
            <div class="stat-icon yellow"><i class="bi bi-stack"></i></div>
            <div class="stat-value" id="flashcardsStudied">0</div>
            <div class="stat-label">Flashcards</div>
        </div>
        <div class="stat-card-profile">
            <div class="stat-icon pink"><i class="bi bi-clock-fill"></i></div>
            <div class="stat-value" id="studyHours">0</div>
            <div class="stat-label">Ore Studio</div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div class="section-header">
        <div>
            <h2 class="section-title"><i class="bi bi-lightbulb text-warning"></i> Raccomandazioni</h2>
            <p class="section-subtitle">Suggerimenti personalizzati per migliorare</p>
        </div>
        <button class="btn btn-outline btn-sm" onclick="generateRecommendations()">
            <i class="bi bi-arrow-clockwise"></i> Aggiorna
        </button>
    </div>
    <div id="recommendationsContainer">
        <div class="empty-recommendations">
            <i class="bi bi-hourglass-split"></i>
            <p style="color: var(--text-muted);">Caricamento...</p>
        </div>
    </div>

    <!-- Badges Section -->
    <div class="section-header" style="margin-top: 2.5rem;">
        <div>
            <h2 class="section-title"><i class="bi bi-award text-warning"></i> Badge e Traguardi</h2>
            <p class="section-subtitle"><span id="unlockedCount">0</span> sbloccati su <span id="totalCount">0</span></p>
        </div>
    </div>
    <div class="badges-grid" id="badgesContainer"></div>
</main>

<script src="js/app.js"></script>
<script src="js/layout.js"></script>
<script src="js/focus-manager.js"></script>
<script>
    let allBadges = [];

    document.addEventListener('DOMContentLoaded', function() {
        initLayout({
            pageTitle: '',
            activePage: 'profile',
            showTopbar: false
        });

        loadProfile();
        loadStats();
        loadBadges();
        loadRecommendations();
    });

    async function loadProfile() {
        // Usa i dati salvati nel localStorage dal login
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (user && (user.firstName || user.lastName || user.email)) {
            const fullName = getUserDisplayName(user);
            const initials = getUserInitials(user);

            document.getElementById('profileName').textContent = fullName;
            document.getElementById('profileEmail').textContent = user.email || '';
            document.getElementById('profileInitials').textContent = initials;

            // Data di registrazione non disponibile nel localStorage, la nascondiamo o mettiamo un placeholder
            document.getElementById('memberSince').textContent = '-';
        } else {
            document.getElementById('profileName').textContent = 'Utente';
            document.getElementById('profileEmail').textContent = '';
            document.getElementById('profileInitials').textContent = 'U';
        }
    }

    async function loadStats() {
        try {
            const response = await apiFetch('/gamification/stats');
            if (response.ok) {
                const stats = await response.json();

                document.getElementById('totalXp').textContent = (stats.totalXp || 0).toLocaleString();
                document.getElementById('weeklyXp').textContent = (stats.weeklyXp || 0).toLocaleString();
                document.getElementById('currentLevel').textContent = stats.level || 1;
                document.getElementById('levelBadge').textContent = stats.level || 1;

                const xpInLevel = stats.xpInCurrentLevel || 0;
                const xpNeeded = stats.xpForNextLevel || 100;
                const progress = Math.min((xpInLevel / xpNeeded) * 100, 100);

                document.getElementById('xpProgressBar').style.width = `${progress}%`;
                document.getElementById('currentXpInLevel').textContent = xpInLevel;
                document.getElementById('xpForNextLevel').textContent = xpNeeded;
                document.getElementById('xpToNextLevel').textContent = Math.max(0, xpNeeded - xpInLevel);

                document.getElementById('currentStreak').textContent = stats.currentStreak || 0;
                document.getElementById('longestStreak').textContent = stats.longestStreak || 0;
                document.getElementById('explanationsCount').textContent = stats.explanationsRequested || 0;
                document.getElementById('quizzesCompleted').textContent = stats.quizzesCompleted || 0;
                document.getElementById('flashcardsStudied').textContent = stats.flashcardsStudied || 0;

                const hours = Math.floor((stats.totalStudyTimeMinutes || 0) / 60);
                document.getElementById('studyHours').textContent = hours;
            }
        } catch (error) {
            console.error('Errore caricamento statistiche:', error);
        }
    }

    async function loadBadges() {
        try {
            const response = await apiFetch('/gamification/badges');
            if (response.ok) {
                allBadges = await response.json();
                renderBadges();
                const unlocked = allBadges.filter(b => b.unlocked).length;
                document.getElementById('unlockedCount').textContent = unlocked;
                document.getElementById('totalCount').textContent = allBadges.length;
            }
        } catch (error) {
            console.error('Errore caricamento badge:', error);
            document.getElementById('badgesContainer').innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                    <i class="bi bi-award" style="font-size: 3rem; color: var(--text-muted);"></i>
                    <p style="color: var(--text-muted); margin-top: 1rem;">Completa attività per sbloccare badge!</p>
                </div>
            `;
        }
    }

    function renderBadges() {
        const container = document.getElementById('badgesContainer');
        if (allBadges.length === 0) {
            container.innerHTML = `<div class="empty-state" style="grid-column:1/-1;text-align:center;padding:2rem;"><i class="bi bi-award" style="font-size:3rem;color:var(--text-muted);"></i><p style="color:var(--text-muted);margin-top:1rem;">Nessun badge disponibile</p></div>`;
            return;
        }
        container.innerHTML = allBadges.map(badge => `
            <div class="badge-card ${badge.unlocked ? 'unlocked' : 'locked'}">
                <div class="badge-icon-container" style="background: ${badge.color || '#6366F1'}">
                    ${badge.unlocked ? `<i class="bi ${badge.icon || 'bi-award'}"></i>` : '<i class="bi bi-lock"></i>'}
                </div>
                <div class="badge-name">${badge.name}</div>
                <div class="badge-description">${badge.description}</div>
                ${!badge.unlocked ? `
                    <div class="badge-progress">
                        <div class="badge-progress-bar"><div class="badge-progress-fill" style="width: ${badge.progress || 0}%"></div></div>
                        <div class="badge-progress-text">${Math.round(badge.progress || 0)}%</div>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    async function loadRecommendations() {
        try {
            const response = await apiFetch('/gamification/recommendations');
            if (response.ok) {
                const recs = await response.json();
                renderRecommendations(recs);
            }
        } catch (error) {
            renderRecommendations([]);
        }
    }

    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');
        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = `
                <div class="empty-recommendations">
                    <i class="bi bi-check-circle"></i>
                    <h4 style="color: #fff; margin-bottom: 0.5rem;">Ottimo lavoro!</h4>
                    <p style="color: var(--text-muted);">Nessuna raccomandazione. Continua così!</p>
                </div>
            `;
            return;
        }
        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation-card">
                <div class="recommendation-content">
                    <div class="recommendation-icon"><i class="bi ${getRecIcon(rec.type)}"></i></div>
                    <div class="recommendation-text">
                        <h4>${rec.title}</h4>
                        <p>${rec.description}</p>
                    </div>
                </div>
                <div class="recommendation-actions">
                    <button class="btn btn-success btn-sm" onclick="dismissRec('${rec.id}')"><i class="bi bi-check-lg"></i></button>
                </div>
            </div>
        `).join('');
    }

    function getRecIcon(type) {
        const icons = { 'REVIEW_TOPIC': 'bi-arrow-repeat', 'RETRY_QUIZ': 'bi-patch-question', 'STUDY_FLASHCARDS': 'bi-stack', 'STREAK_REMINDER': 'bi-fire' };
        return icons[type] || 'bi-lightbulb';
    }

    async function generateRecommendations() {
        const btn = event.target.closest('button');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;"></span>';
        try {
            await apiFetch('/gamification/recommendations/generate', { method: 'POST' });
            await loadRecommendations();
        } catch (e) {}
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Aggiorna';
    }

    async function dismissRec(id) {
        try {
            await apiFetch(`/gamification/recommendations/${id}/dismiss`, { method: 'POST' });
            loadRecommendations();
        } catch (e) {}
    }
</script>
</body>
</html>