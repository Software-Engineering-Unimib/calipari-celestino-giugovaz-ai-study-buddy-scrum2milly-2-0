<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
<!-- Mobile Menu Button -->
<button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="bi bi-list"></i>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-logo">
        <i class="bi bi-mortarboard-fill"></i>
        <h1>AI Study Buddy</h1>
    </a>

    <nav class="sidebar-nav">
        <div class="nav-section-title">Studio</div>
        <a href="spiegazioni.html" class="nav-item">
            <i class="bi bi-chat-dots"></i>
            <span>Spiegazioni AI</span>
        </a>
        <a href="quiz.html" class="nav-item active">
            <i class="bi bi-patch-question"></i>
            <span>Quiz</span>
        </a>
        <a href="flashcards.html" class="nav-item">
            <i class="bi bi-stack"></i>
            <span>Flashcards</span>
        </a>
    </nav>

    <div class="sidebar-footer">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">MC</div>
            <div class="user-details">
                <div class="user-name" id="userName">Mario Calipari</div>
                <div class="user-level">Livello 5</div>
            </div>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-patch-question text-primary me-2"></i>
            Quiz AI
        </h1>
        <p class="page-subtitle">Genera quiz personalizzati su qualsiasi argomento</p>
    </div>

    <div id="alertContainer"></div>

    <div class="quiz-container">
        <!-- Quiz Setup -->
        <div id="quizSetup" class="quiz-setup">
            <h3 class="card-title mb-4">Configura il tuo Quiz</h3>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Argomento</label>
                    <input
                            type="text"
                            class="form-control"
                            id="quizTopic"
                            placeholder="es. Seconda Guerra Mondiale, Derivate, Programmazione Java..."
                    >
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Numero domande</label>
                    <select class="form-control form-select" id="numQuestions">
                        <option value="5" selected>5 domande</option>
                        <option value="10">10 domande</option>
                        <option value="15">15 domande</option>
                        <option value="20">20 domande</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Difficolt√†</label>
                    <select class="form-control form-select" id="quizDifficulty">
                        <option value="PRINCIPIANTE">Facile</option>
                        <option value="INTERMEDIO" selected>Media</option>
                        <option value="AVANZATO">Difficile</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end mb-3">
                    <button class="btn btn-primary btn-lg w-100" id="generateBtn" onclick="generateQuiz()">
                        <i class="bi bi-magic me-2"></i>
                        <span id="generateBtnText">Genera Quiz</span>
                        <span id="generateBtnSpinner" class="d-none">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Generazione...
                            </span>
                    </button>
                </div>
            </div>

            <!-- Quiz History -->
            <div id="quizHistorySection" class="mt-5 d-none">
                <h4 class="mb-3">
                    <i class="bi bi-clock-history me-2"></i>
                    I tuoi Quiz recenti
                </h4>
                <div id="quizHistoryList" class="row"></div>
            </div>
        </div>

        <!-- Quiz Questions (hidden initially) -->
        <div id="quizQuestionsContainer" class="d-none">
            <!-- Header -->
            <div class="quiz-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1" id="quizTitle">Quiz</h4>
                        <span class="text-muted" id="quizInfo"></span>
                    </div>
                    <button class="btn btn-outline" onclick="resetQuiz()">
                        <i class="bi bi-arrow-left me-1"></i>
                        Nuovo Quiz
                    </button>
                </div>
                <div class="quiz-progress">
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="quiz-progress-text">
                        <span id="progressText">Domanda 1 di 5</span>
                        <span id="scoreText">Punteggio: 0</span>
                    </div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="questionContainer"></div>

            <!-- Navigation -->
            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary" id="prevBtn" onclick="prevQuestion()" disabled>
                    <i class="bi bi-arrow-left me-1"></i>
                    Precedente
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                    Successiva
                    <i class="bi bi-arrow-right ms-1"></i>
                </button>
            </div>
        </div>

        <!-- Quiz Results (hidden initially) -->
        <div id="quizResults" class="d-none">
            <div class="quiz-question-card">
                <div class="quiz-result">
                    <div class="quiz-result-score" id="finalScore">0%</div>
                    <div class="quiz-result-label" id="finalLabel">Complimenti!</div>

                    <div class="row justify-content-center mb-4">
                        <div class="col-auto">
                            <div class="stat-card">
                                <div class="card-icon success">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div>
                                    <div class="stat-value text-success" id="correctCount">0</div>
                                    <div class="stat-label">Corrette</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="stat-card">
                                <div class="card-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger-color);">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                                <div>
                                    <div class="stat-value text-danger" id="incorrectCount">0</div>
                                    <div class="stat-label">Sbagliate</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-outline" onclick="reviewAnswers()">
                            <i class="bi bi-eye me-1"></i>
                            Rivedi risposte
                        </button>
                        <button class="btn btn-primary" onclick="resetQuiz()">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            Nuovo Quiz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script>
    // Quiz state
    let currentQuiz = null;      // Quiz object dal server (con ID)
    let quizQuestions = [];      // Array di domande
    let currentQuestion = 0;
    let userAnswers = {};        // { questionId: "A", questionId2: "B", ... }
    let score = 0;

    // On page load
    document.addEventListener('DOMContentLoaded', function() {
        loadQuizHistory();
    });

    // Generate Quiz - NUOVO: usa POST e salva nel DB
    async function generateQuiz() {
        const topic = document.getElementById('quizTopic').value.trim();
        const numQuestions = document.getElementById('numQuestions').value;
        const difficulty = document.getElementById('quizDifficulty').value;

        if (!topic) {
            showAlert('Inserisci un argomento per il quiz', 'error');
            return;
        }

        const btn = document.getElementById('generateBtn');
        const btnText = document.getElementById('generateBtnText');
        const btnSpinner = document.getElementById('generateBtnSpinner');

        btn.disabled = true;
        btnText.classList.add('d-none');
        btnSpinner.classList.remove('d-none');

        try {
            // NUOVO: chiamata POST che salva nel DB
            const response = await apiFetch(
                `/ai/quiz/generate?topic=${encodeURIComponent(topic)}&numberOfQuestions=${numQuestions}&difficulty=${difficulty}`,
                { method: 'POST' }
            );

            if (response.ok) {
                const quiz = await response.json();

                // Salva il quiz corrente
                currentQuiz = quiz;
                quizQuestions = quiz.questions || [];

                if (quizQuestions.length === 0) {
                    throw new Error('Nessuna domanda generata');
                }

                // Initialize quiz state
                currentQuestion = 0;
                userAnswers = {};
                score = 0;

                // Avvia il quiz (segna ora inizio)
                await startQuiz(quiz.id);

                // Update UI
                document.getElementById('quizTitle').textContent = quiz.title || `Quiz: ${topic}`;
                document.getElementById('quizInfo').textContent =
                    `${quizQuestions.length} domande ‚Ä¢ Difficolt√†: ${getDifficultyLabel(difficulty)}`;

                // Show quiz
                document.getElementById('quizSetup').classList.add('d-none');
                document.getElementById('quizQuestionsContainer').classList.remove('d-none');

                renderQuestion();
            } else {
                const error = await response.text();
                showAlert(getErrorMessage(error), 'error');
            }
        } catch (error) {
            console.error('Errore:', error);
            showAlert('Errore nella generazione del quiz. Riprova.', 'error');
        } finally {
            btn.disabled = false;
            btnText.classList.remove('d-none');
            btnSpinner.classList.add('d-none');
        }
    }

    // Start quiz (mark start time)
    async function startQuiz(quizId) {
        try {
            await apiFetch(`/ai/quiz/${quizId}/start`, { method: 'POST' });
        } catch (error) {
            console.warn('Errore start quiz:', error);
        }
    }

    // Helper per label difficolt√†
    function getDifficultyLabel(difficulty) {
        const labels = {
            'PRINCIPIANTE': 'Facile',
            'INTERMEDIO': 'Media',
            'AVANZATO': 'Difficile'
        };
        return labels[difficulty] || difficulty;
    }

    // Render current question
    function renderQuestion() {
        const q = quizQuestions[currentQuestion];
        const container = document.getElementById('questionContainer');
        const letters = ['A', 'B', 'C', 'D'];

        // Costruisci le opzioni dalla struttura Question
        const options = [q.optionA, q.optionB, q.optionC, q.optionD];

        let optionsHtml = '';
        options.forEach((option, index) => {
            const letter = letters[index];
            const isSelected = userAnswers[q.id] === letter;
            optionsHtml += `
                <div class="quiz-option ${isSelected ? 'selected' : ''}" onclick="selectOption('${q.id}', '${letter}')">
                    <div class="quiz-option-letter">${letter}</div>
                    <div class="quiz-option-text">${option}</div>
                </div>
            `;
        });

        container.innerHTML = `
            <div class="quiz-question-card">
                <div class="quiz-question-number">Domanda ${currentQuestion + 1}</div>
                <div class="quiz-question-text">${q.questionText}</div>
                <div class="quiz-options">
                    ${optionsHtml}
                </div>
            </div>
        `;

        updateProgress();
        updateNavigation();
    }

    // Select option
    function selectOption(questionId, letter) {
        userAnswers[questionId] = letter;
        renderQuestion();
    }

    // Update progress bar
    function updateProgress() {
        const progress = ((currentQuestion + 1) / quizQuestions.length) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `Domanda ${currentQuestion + 1} di ${quizQuestions.length}`;

        const answered = Object.keys(userAnswers).length;
        document.getElementById('scoreText').textContent = `Risposte: ${answered}/${quizQuestions.length}`;
    }

    // Update navigation buttons
    function updateNavigation() {
        document.getElementById('prevBtn').disabled = currentQuestion === 0;

        const nextBtn = document.getElementById('nextBtn');
        if (currentQuestion === quizQuestions.length - 1) {
            nextBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Termina Quiz';
            nextBtn.onclick = finishQuiz;
        } else {
            nextBtn.innerHTML = 'Successiva <i class="bi bi-arrow-right ms-1"></i>';
            nextBtn.onclick = nextQuestion;
        }
    }

    // Navigation
    function prevQuestion() {
        if (currentQuestion > 0) {
            currentQuestion--;
            renderQuestion();
        }
    }

    function nextQuestion() {
        if (currentQuestion < quizQuestions.length - 1) {
            currentQuestion++;
            renderQuestion();
        }
    }

    // Finish quiz - NUOVO: invia al server per salvare
    async function finishQuiz() {
        try {
            // Prepara le risposte nel formato richiesto dal server
            const answersPayload = {
                quizId: currentQuiz.id,
                answers: userAnswers
            };

            // Invia al server
            const response = await apiFetch('/ai/quiz/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answersPayload)
            });

            if (response.ok) {
                const result = await response.json();

                // Aggiorna lo stato locale
                score = result.score;
                const percentage = Math.round(result.percentage);

                // Update results UI
                document.getElementById('finalScore').textContent = `${percentage}%`;
                document.getElementById('correctCount').textContent = result.score;
                document.getElementById('incorrectCount').textContent = result.totalQuestions - result.score;

                // Set label based on score
                let label = 'Puoi fare di meglio!';
                if (percentage >= 90) label = 'Eccellente! üéâ';
                else if (percentage >= 70) label = 'Ottimo lavoro! üëè';
                else if (percentage >= 50) label = 'Buon risultato! üí™';
                document.getElementById('finalLabel').textContent = label;

                // Show results
                document.getElementById('quizQuestionsContainer').classList.add('d-none');
                document.getElementById('quizResults').classList.remove('d-none');

                showAlert(`Quiz completato e salvato! Punteggio: ${percentage}%`, 'success');
            } else {
                throw new Error('Errore nel salvataggio');
            }
        } catch (error) {
            console.error('Errore:', error);
            // Fallback: calcola localmente se il server fallisce
            calculateScoreLocally();
        }
    }

    // Fallback: calcolo locale del punteggio
    function calculateScoreLocally() {
        score = 0;
        quizQuestions.forEach(q => {
            const userAnswer = userAnswers[q.id];
            if (userAnswer && userAnswer === q.correctAnswer) {
                score++;
            }
        });

        const percentage = Math.round((score / quizQuestions.length) * 100);

        document.getElementById('finalScore').textContent = `${percentage}%`;
        document.getElementById('correctCount').textContent = score;
        document.getElementById('incorrectCount').textContent = quizQuestions.length - score;

        let label = 'Puoi fare di meglio!';
        if (percentage >= 90) label = 'Eccellente! üéâ';
        else if (percentage >= 70) label = 'Ottimo lavoro! üëè';
        else if (percentage >= 50) label = 'Buon risultato! üí™';
        document.getElementById('finalLabel').textContent = label;

        document.getElementById('quizQuestionsContainer').classList.add('d-none');
        document.getElementById('quizResults').classList.remove('d-none');
    }

    // Review answers
    function reviewAnswers() {
        document.getElementById('quizResults').classList.add('d-none');
        document.getElementById('quizQuestionsContainer').classList.remove('d-none');
        currentQuestion = 0;
        renderQuestionReview();
    }

    // Render question in review mode
    function renderQuestionReview() {
        const q = quizQuestions[currentQuestion];
        const container = document.getElementById('questionContainer');
        const letters = ['A', 'B', 'C', 'D'];
        const options = [q.optionA, q.optionB, q.optionC, q.optionD];

        const userAnswer = userAnswers[q.id];
        const isUserCorrect = userAnswer === q.correctAnswer;

        let optionsHtml = '';
        options.forEach((option, index) => {
            const letter = letters[index];
            const isCorrect = letter === q.correctAnswer;
            const isUserAnswer = userAnswer === letter;

            let className = '';
            if (isCorrect) className = 'correct';
            else if (isUserAnswer && !isCorrect) className = 'incorrect';

            optionsHtml += `
                <div class="quiz-option ${className}">
                    <div class="quiz-option-letter">${letter}</div>
                    <div class="quiz-option-text">
                        ${option}
                        ${isCorrect ? '<i class="bi bi-check-lg ms-2 text-success"></i>' : ''}
                        ${isUserAnswer && !isCorrect ? '<i class="bi bi-x-lg ms-2 text-danger"></i>' : ''}
                    </div>
                </div>
            `;
        });

        container.innerHTML = `
            <div class="quiz-question-card">
                <div class="quiz-question-number">
                    Domanda ${currentQuestion + 1}
                    ${isUserCorrect ?
                        '<span class="badge bg-success ms-2">Corretta</span>' :
                        '<span class="badge bg-danger ms-2">Sbagliata</span>'}
                </div>
                <div class="quiz-question-text">${q.questionText}</div>
                <div class="quiz-options">
                    ${optionsHtml}
                </div>
                ${q.explanation ? `<div class="alert alert-info mt-3"><i class="bi bi-info-circle me-2"></i>${q.explanation}</div>` : ''}
            </div>
        `;

        updateProgress();

        // Update navigation for review mode
        document.getElementById('prevBtn').disabled = currentQuestion === 0;
        const nextBtn = document.getElementById('nextBtn');
        if (currentQuestion === quizQuestions.length - 1) {
            nextBtn.innerHTML = '<i class="bi bi-bar-chart me-1"></i> Torna ai risultati';
            nextBtn.onclick = () => {
                document.getElementById('quizQuestionsContainer').classList.add('d-none');
                document.getElementById('quizResults').classList.remove('d-none');
            };
        } else {
            nextBtn.innerHTML = 'Successiva <i class="bi bi-arrow-right ms-1"></i>';
            nextBtn.onclick = () => {
                currentQuestion++;
                renderQuestionReview();
            };
        }

        document.getElementById('prevBtn').onclick = () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestionReview();
            }
        };
    }

    // Load quiz history
    async function loadQuizHistory() {
        try {
            const response = await apiFetch('/ai/quiz/my');
            if (response.ok) {
                const quizzes = await response.json();
                if (quizzes.length > 0) {
                    renderQuizHistory(quizzes.slice(0, 6)); // Mostra ultimi 6
                }
            }
        } catch (error) {
            console.warn('Errore caricamento storico:', error);
        }
    }

    // Render quiz history
    function renderQuizHistory(quizzes) {
        const section = document.getElementById('quizHistorySection');
        const list = document.getElementById('quizHistoryList');

        let html = '';
        quizzes.forEach(quiz => {
            const date = new Date(quiz.createdAt).toLocaleDateString('it-IT');
            const statusBadge = quiz.isCompleted
                ? `<span class="badge bg-success">${quiz.percentage}%</span>`
                : '<span class="badge bg-warning">In corso</span>';

            html += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100" style="cursor: pointer;" onclick="loadQuiz('${quiz.id}')">
                        <div class="card-body">
                            <h6 class="card-title">${quiz.title}</h6>
                            <p class="card-text text-muted small">
                                ${quiz.numberOfQuestions} domande ‚Ä¢ ${date}
                            </p>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            `;
        });

        list.innerHTML = html;
        section.classList.remove('d-none');
    }

    // Load existing quiz
    async function loadQuiz(quizId) {
        try {
            const response = await apiFetch(`/ai/quiz/${quizId}`);
            if (response.ok) {
                const quiz = await response.json();
                currentQuiz = quiz;
                quizQuestions = quiz.questions || [];
                currentQuestion = 0;

                // Ripristina le risposte salvate
                userAnswers = {};
                quizQuestions.forEach(q => {
                    if (q.userAnswer) {
                        userAnswers[q.id] = q.userAnswer;
                    }
                });

                document.getElementById('quizTitle').textContent = quiz.title;
                document.getElementById('quizInfo').textContent =
                    `${quizQuestions.length} domande ‚Ä¢ ${getDifficultyLabel(quiz.difficultyLevel)}`;

                document.getElementById('quizSetup').classList.add('d-none');

                if (quiz.isCompleted) {
                    // Mostra risultati
                    score = quiz.score || 0;
                    const percentage = Math.round(quiz.percentage || 0);
                    document.getElementById('finalScore').textContent = `${percentage}%`;
                    document.getElementById('correctCount').textContent = score;
                    document.getElementById('incorrectCount').textContent = quizQuestions.length - score;
                    document.getElementById('quizResults').classList.remove('d-none');
                } else {
                    // Continua quiz
                    document.getElementById('quizQuestionsContainer').classList.remove('d-none');
                    renderQuestion();
                }
            }
        } catch (error) {
            console.error('Errore:', error);
            showAlert('Errore nel caricamento del quiz', 'error');
        }
    }

    // Reset quiz
    function resetQuiz() {
        currentQuiz = null;
        quizQuestions = [];
        currentQuestion = 0;
        userAnswers = {};
        score = 0;

        document.getElementById('quizSetup').classList.remove('d-none');
        document.getElementById('quizQuestionsContainer').classList.add('d-none');
        document.getElementById('quizResults').classList.add('d-none');
        document.getElementById('quizTopic').value = '';

        // Ricarica storico
        loadQuizHistory();
    }
</script>
</body>
</html>