<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - AI Study Buddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

    body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 1rem;
    }

    .login-container { width: 100%; max-width: 420px; }

    .login-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px; padding: 2.5rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-header { text-align: center; margin-bottom: 2rem; }

    .login-logo {
        width: 80px; height: 80px;
        background: var(--primary-gradient); border-radius: 20px;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 1rem; font-size: 2rem; color: white;
    }

    .login-title { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .login-subtitle { color: #6c757d; font-size: 0.9rem; }

    .form-control {
        border-radius: 12px; padding: 0.75rem 1rem;
        border: 2px solid #e9ecef; transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-primary {
        background: var(--primary-gradient); border: none;
        border-radius: 12px; padding: 0.75rem 1.5rem;
        font-weight: 600; transition: all 0.3s ease;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
    .btn-primary:disabled { opacity: 0.7; transform: none; }

    .divider { display: flex; align-items: center; margin: 1.5rem 0; color: #6c757d; }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e9ecef; }
    .divider span { padding: 0 1rem; }

    .register-link { text-align: center; color: #6c757d; }
    .register-link a { color: #667eea; text-decoration: none; font-weight: 600; }

    .password-toggle {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        background: none; border: none; color: #6c757d; cursor: pointer; z-index: 10;
    }

    .alert { border-radius: 12px; border: none; }
  </style>
</head>
<body>
<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <div class="login-logo"><i class="bi bi-mortarboard-fill"></i></div>
      <h1 class="login-title">Bentornato!</h1>
      <p class="login-subtitle">Accedi al tuo account AI Study Buddy</p>
    </div>

    <div id="alertContainer"></div>

    <form id="loginForm">
      <div class="form-floating mb-3">
        <input type="email" class="form-control" id="email" placeholder="Email" required autocomplete="email">
        <label for="email"><i class="bi bi-envelope me-2"></i>Email</label>
      </div>

      <div class="form-floating mb-3 position-relative">
        <input type="password" class="form-control" id="password" placeholder="Password" required autocomplete="current-password">
        <label for="password"><i class="bi bi-lock me-2"></i>Password</label>
        <button type="button" class="password-toggle" onclick="togglePassword()">
          <i class="bi bi-eye" id="passwordToggleIcon"></i>
        </button>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="rememberMe">
          <label class="form-check-label small" for="rememberMe">Ricordami</label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100 py-2" id="loginBtn">
        <span id="loginBtnText"><i class="bi bi-box-arrow-in-right me-2"></i>Accedi</span>
        <span id="loginBtnSpinner" class="d-none">
          <span class="spinner-border spinner-border-sm me-2"></span>Accesso...
        </span>
      </button>
    </form>

    <div class="divider"><span>oppure</span></div>
    <p class="register-link mb-0">Non hai un account? <a href="register.html">Registrati</a></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = '/api';

  document.addEventListener('DOMContentLoaded', function() {
      // Mostra messaggio sessione scaduta
      const authMessage = sessionStorage.getItem('authMessage');
      if (authMessage) {
          sessionStorage.removeItem('authMessage');
          showAlert(authMessage, 'warning');
      }

      // Redirect se giÃ  loggato con token valido
      const token = localStorage.getItem('token');
      if (token && !isTokenExpired()) {
          window.location.href = 'dashboard.html';
      }
  });

  function isTokenExpired() {
      const token = localStorage.getItem('token');
      if (!token) return true;
      try {
          const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
          return Date.now() >= payload.exp * 1000;
      } catch (e) { return true; }
  }

  function togglePassword() {
      const input = document.getElementById('password');
      const icon = document.getElementById('passwordToggleIcon');
      if (input.type === 'password') {
          input.type = 'text';
          icon.classList.replace('bi-eye', 'bi-eye-slash');
      } else {
          input.type = 'password';
          icon.classList.replace('bi-eye-slash', 'bi-eye');
      }
  }

  function showAlert(message, type = 'error') {
      const container = document.getElementById('alertContainer');
      const alertClass = { error: 'alert-danger', success: 'alert-success', warning: 'alert-warning' }[type] || 'alert-info';
      const icon = { error: 'bi-exclamation-circle', success: 'bi-check-circle', warning: 'bi-exclamation-triangle' }[type] || 'bi-info-circle';
      container.innerHTML = `<div class="alert ${alertClass} d-flex align-items-center"><i class="bi ${icon} me-2"></i>${message}</div>`;
      setTimeout(() => { if (container.firstChild) container.innerHTML = ''; }, 5000);
  }

  function setLoading(loading) {
      document.getElementById('loginBtn').disabled = loading;
      document.getElementById('loginBtnText').classList.toggle('d-none', loading);
      document.getElementById('loginBtnSpinner').classList.toggle('d-none', !loading);
  }

  document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) { showAlert('Inserisci email e password'); return; }

      setLoading(true);

      try {
          const response = await fetch(`${API_BASE}/auth/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
          });

          const data = await response.json();

          if (response.ok && data.token) {
              // Salva il token
              localStorage.setItem('token', data.token);

              // IMPORTANTE: Salva i dati utente dalla risposta (sono al primo livello, non in data.user)
              const userData = {
                  id: data.userId,
                  firstName: data.firstName,
                  lastName: data.lastName,
                  email: data.email
              };
              localStorage.setItem('user', JSON.stringify(userData));

              showAlert('Login riuscito!', 'success');
              setTimeout(() => window.location.href = 'dashboard.html', 500);
          } else {
              showAlert(data.message || data.error || 'Credenziali non valide', 'error');
          }
      } catch (error) {
          showAlert('Errore di connessione. Riprova.', 'error');
      } finally {
          setLoading(false);
      }
  });
</script>
</body>
</html>