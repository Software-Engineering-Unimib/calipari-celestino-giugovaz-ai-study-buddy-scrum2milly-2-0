<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiegazioni AI - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        /* Search Section */
        .search-section {
            background: var(--gradient-primary);
            border-radius: 1rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .search-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .search-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .search-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 1.5rem;
        }

        .search-form {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            background: rgba(255,255,255,0.95);
            font-size: 1rem;
            color: var(--dark-bg);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }

        .search-input::placeholder {
            color: #6b7280;
        }

        .level-select {
            padding: 1rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            background: rgba(255,255,255,0.95);
            font-size: 1rem;
            color: var(--dark-bg);
            cursor: pointer;
            min-width: 180px;
        }

        .level-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-btn {
            padding: 1rem 2rem;
            background: #ffffff;
            color: var(--primary-color);
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .search-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* XP Badge */
        .xp-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            color: #ffffff;
            margin-left: 0.5rem;
        }

        /* Explanation Card */
        .explanation-card {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .explanation-topic {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .explanation-topic i { color: var(--primary-color); }

        .explanation-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .meta-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .meta-badge.level { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .meta-badge.xp { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .meta-badge.time { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        .explanation-content {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 1rem;
        }

        .explanation-content h1, .explanation-content h2, .explanation-content h3 {
            color: #ffffff;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .explanation-content h1 { font-size: 1.5rem; }
        .explanation-content h2 { font-size: 1.25rem; }
        .explanation-content h3 { font-size: 1.1rem; }
        .explanation-content p { margin-bottom: 1rem; }
        .explanation-content ul, .explanation-content ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .explanation-content li { margin-bottom: 0.5rem; }

        .explanation-content code {
            background: rgba(139, 92, 246, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a78bfa;
        }

        .explanation-content pre {
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .explanation-content pre code { background: none; padding: 0; }
        .explanation-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-muted);
            font-style: italic;
        }
        .explanation-content strong { color: #ffffff; }

        /* Actions */
        .explanation-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--dark-border);
            flex-wrap: wrap;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .action-btn.primary { background: var(--primary-color); color: #ffffff; }
        .action-btn.primary:hover { background: var(--primary-hover); }
        .action-btn.secondary { background: var(--dark-border); color: var(--text-secondary); }
        .action-btn.secondary:hover { background: rgba(107, 114, 128, 0.3); color: #ffffff; }

        /* History Section */
        .history-section { margin-top: 2rem; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-list { display: flex; flex-direction: column; gap: 0.75rem; }

        .history-item {
            background: var(--dark-card);
            border: 2px solid var(--dark-border);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover { border-color: var(--primary-color); transform: translateX(4px); }

        .history-item-info { display: flex; align-items: center; gap: 1rem; }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .history-topic { font-weight: 600; color: #ffffff; margin-bottom: 0.25rem; }
        .history-date { font-size: 0.8rem; color: var(--text-muted); }
        .history-item-meta { display: flex; align-items: center; gap: 0.5rem; }

        /* Loading */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid var(--dark-border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { font-size: 1rem; color: var(--text-secondary); }
        .loading-subtext { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state h3 { color: #ffffff; margin-bottom: 0.5rem; }

        /* XP Notification */
        .xp-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--gradient-primary);
            color: #ffffff;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.4);
            z-index: 1000;
            animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100px); }
        }

        .xp-notification i { font-size: 1.5rem; }
        .xp-notification .xp-amount { font-size: 1.25rem; font-weight: 700; }

        /* Quick Topics */
        .quick-topics { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }

        .quick-topic {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 2rem;
            color: #ffffff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-topic:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        /* Responsive */
        @media (max-width: 768px) {
            .search-section { padding: 1.5rem; }
            .search-form { flex-direction: column; }
            .level-select, .search-btn { width: 100%; justify-content: center; }
            .explanation-header { flex-direction: column; }
            .explanation-actions { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
<main class="main-content">
    <!-- Search Section -->
    <div class="search-section">
        <h1 class="search-title">
            <i class="bi bi-lightbulb-fill me-2"></i>
            Chiedi una Spiegazione
            <span class="xp-badge"><i class="bi bi-lightning-charge-fill"></i> +10 XP</span>
        </h1>
        <p class="search-subtitle">
            Inserisci un argomento e l'AI ti fornir√† una spiegazione personalizzata
        </p>

        <form class="search-form" id="explanationForm" onsubmit="requestExplanation(event)">
            <div class="search-input-wrapper">
                <i class="bi bi-search"></i>
                <input type="text" class="search-input" id="topicInput"
                       placeholder="Es: Teorema di Pitagora, Fotosintesi, Guerra Fredda..."
                       required autocomplete="off">
            </div>


            <button type="submit" class="search-btn" id="submitBtn">
                <i class="bi bi-stars"></i>
                Genera Spiegazione
            </button>
        </form>

        <div class="quick-topics">
            <span class="quick-topic" onclick="setTopic('Derivate e integrali')">üìê Derivate</span>
            <span class="quick-topic" onclick="setTopic('Leggi della termodinamica')">üî• Termodinamica</span>
            <span class="quick-topic" onclick="setTopic('Rivoluzione Francese')">üè∞ Rivoluzione Francese</span>
            <span class="quick-topic" onclick="setTopic('Struttura del DNA')">üß¨ DNA</span>
            <span class="quick-topic" onclick="setTopic('Machine Learning')">ü§ñ Machine Learning</span>
        </div>
    </div>

    <!-- Current Explanation -->
    <div id="explanationContainer"></div>

    <!-- History Section -->
    <div class="history-section" id="historySection">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-clock-history"></i>
                Cronologia Spiegazioni
            </h2>
            <button class="btn btn-outline btn-sm" onclick="clearHistory()">
                <i class="bi bi-trash3"></i> Cancella
            </button>
        </div>
        <div class="history-list" id="historyList"></div>
    </div>
</main>

<script src="js/layout.js"></script>
<script src="js/focus-manager.js"></script>
<script>
    let explanationHistory = [];

    document.addEventListener('DOMContentLoaded', function() {
        initLayout({
            pageTitle: 'Spiegazioni AI',
            activePage: 'spiegazioni',
            showTopbar: true,
            showFooter: true
        });

        loadHistory();

        const savedTopic = sessionStorage.getItem('explanationTopic');
        if (savedTopic) {
            document.getElementById('topicInput').value = savedTopic;
            sessionStorage.removeItem('explanationTopic');
        }
    });

    async function apiFetch(endpoint, options = {}) {
        const token = localStorage.getItem('token');

        const headers = {
            'Authorization': token ? `Bearer ${token}` : '',
            ...options.headers
        };

        if (options.body && !headers['Content-Type']) {
            headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(`/api${endpoint}`, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
            throw new Error('Non autorizzato');
        }

        return response;
    }

    function setTopic(topic) {
        document.getElementById('topicInput').value = topic;
        document.getElementById('topicInput').focus();
    }

    async function requestExplanation(event) {
        event.preventDefault();

        const topic = document.getElementById('topicInput').value.trim();
        const level = document.getElementById('levelSelect').value;

        if (!topic) {
            showNotification('Inserisci un argomento', 'warning');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const container = document.getElementById('explanationContainer');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner" style="width:20px;height:20px;border-width:2px;"></span> Generando...';

        container.innerHTML = `
            <div class="explanation-card">
                <div class="loading-container">
                    <div class="loading-spinner-large"></div>
                    <div class="loading-text">Sto generando la spiegazione...</div>
                    <div class="loading-subtext">L'AI sta elaborando "${escapeHtml(topic)}"</div>
                </div>
            </div>
        `;

        try {
            const response = await apiFetch(`/ai/explain?topic=${encodeURIComponent(topic)}&level=${encodeURIComponent(level)}`);

            if (response.ok) {
                const data = await response.json();
                displayExplanation(topic, level, data.explanation, data);

                if (data.xpEarned) {
                    showXpNotification(data.xpEarned, data.leveledUp);
                }

                if (typeof loadTopbarStats === 'function') {
                    loadTopbarStats();
                }

                saveToHistory(topic, level, data.explanation);
                document.getElementById('topicInput').value = '';
            } else {
                const error = await response.text();
                throw new Error(error || 'Errore nella generazione');
            }
        } catch (error) {
            console.error('Errore:', error);
            container.innerHTML = `
                <div class="explanation-card">
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h3>Errore</h3>
                        <p>${error.message || 'Si √® verificato un errore. Riprova.'}</p>
                        <button class="btn btn-primary mt-3" onclick="document.getElementById('topicInput').focus()">
                            Riprova
                        </button>
                    </div>
                </div>
            `;
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-stars"></i> Genera Spiegazione';
        }
    }

    function displayExplanation(topic, level, explanation, xpData = {}) {
        const container = document.getElementById('explanationContainer');
        const levelLabels = {
            'scuola_media': 'Scuola Media',
            'scuola_superiore': 'Scuola Superiore',
            'universit√†': 'Universit√†',
            'esperto': 'Esperto'
        };

        const formattedExplanation = formatExplanation(explanation);
        const safeTopic = escapeHtml(topic).replace(/'/g, "\\'");

        container.innerHTML = `
            <div class="explanation-card">
                <div class="explanation-header">
                    <div class="explanation-topic">
                        <i class="bi bi-lightbulb-fill"></i>
                        ${escapeHtml(topic)}
                    </div>
                    <div class="explanation-meta">
                        <span class="meta-badge level">
                            <i class="bi bi-mortarboard"></i>
                            ${levelLabels[level] || level}
                        </span>
                        ${xpData.xpEarned ? `
                            <span class="meta-badge xp">
                                <i class="bi bi-lightning-charge-fill"></i>
                                +${xpData.xpEarned} XP
                            </span>
                        ` : ''}
                        <span class="meta-badge time">
                            <i class="bi bi-clock"></i>
                            Adesso
                        </span>
                    </div>
                </div>

                <div class="explanation-content">${formattedExplanation}</div>

                <div class="explanation-actions">
                    <button class="action-btn primary" onclick="generateQuizFromTopic('${safeTopic}')">
                        <i class="bi bi-patch-question"></i> Genera Quiz
                    </button>
                    <button class="action-btn primary" onclick="generateFlashcardsFromTopic('${safeTopic}')">
                        <i class="bi bi-stack"></i> Crea Flashcards
                    </button>
                    <button class="action-btn secondary" onclick="copyExplanation()">
                        <i class="bi bi-clipboard"></i> Copia
                    </button>
                    <button class="action-btn secondary" onclick="requestExplanationAgain('${safeTopic}', '${level}')">
                        <i class="bi bi-arrow-clockwise"></i> Rigenera
                    </button>
                </div>
            </div>
        `;

        container.dataset.rawContent = explanation;
    }

    function formatExplanation(text) {
        if (!text) return '';
        return text
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/^\- (.*$)/gm, '<li>$1</li>')
            .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
            .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/<p><\/p>/g, '');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyExplanation() {
        const container = document.getElementById('explanationContainer');
        const rawContent = container.dataset.rawContent;
        if (rawContent) {
            navigator.clipboard.writeText(rawContent).then(() => {
                showNotification('Spiegazione copiata!', 'success');
            });
        }
    }

    function requestExplanationAgain(topic, level) {
        document.getElementById('topicInput').value = topic;
        document.getElementById('levelSelect').value = level;
        document.getElementById('explanationForm').dispatchEvent(new Event('submit'));
    }

    function generateQuizFromTopic(topic) {
        sessionStorage.setItem('quizTopic', topic);
        window.location.href = 'quiz.html';
    }

    function generateFlashcardsFromTopic(topic) {
        sessionStorage.setItem('flashcardTopic', topic);
        window.location.href = 'flashcards.html';
    }

    function showXpNotification(xpEarned, leveledUp = false) {
        const notification = document.createElement('div');
        notification.className = 'xp-notification';
        notification.innerHTML = `
            <i class="bi bi-lightning-charge-fill"></i>
            <div>
                <div class="xp-amount">+${xpEarned} XP</div>
                ${leveledUp ? '<small>üéâ Livello aumentato!</small>' : ''}
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}`;
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;padding:1rem 1.5rem;border-radius:0.5rem;';
        toast.innerHTML = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function loadHistory() {
        const saved = localStorage.getItem('explanationHistory');
        if (saved) explanationHistory = JSON.parse(saved);
        renderHistory();
    }

    function saveToHistory(topic, level, explanation) {
        const item = { id: Date.now(), topic, level, explanation, timestamp: new Date().toISOString() };
        explanationHistory.unshift(item);
        if (explanationHistory.length > 20) explanationHistory = explanationHistory.slice(0, 20);
        localStorage.setItem('explanationHistory', JSON.stringify(explanationHistory));
        renderHistory();
    }

    function renderHistory() {
        const container = document.getElementById('historyList');
        const section = document.getElementById('historySection');

        if (explanationHistory.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';

        container.innerHTML = explanationHistory.map(item => {
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleDateString('it-IT', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            return `
                <div class="history-item" onclick="loadFromHistory(${item.id})">
                    <div class="history-item-info">
                        <div class="history-icon"><i class="bi bi-lightbulb"></i></div>
                        <div>
                            <div class="history-topic">${escapeHtml(item.topic)}</div>
                            <div class="history-date">${formattedDate}</div>
                        </div>
                    </div>
                    <div class="history-item-meta">
                        <span class="meta-badge level">${item.level}</span>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                </div>
            `;
        }).join('');
    }

    function loadFromHistory(id) {
        const item = explanationHistory.find(h => h.id === id);
        if (item) {
            displayExplanation(item.topic, item.level, item.explanation);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function clearHistory() {
        if (confirm('Sei sicuro di voler cancellare la cronologia?')) {
            explanationHistory = [];
            localStorage.removeItem('explanationHistory');
            renderHistory();
            showNotification('Cronologia cancellata', 'success');
        }
    }
</script>
</body>
</html>