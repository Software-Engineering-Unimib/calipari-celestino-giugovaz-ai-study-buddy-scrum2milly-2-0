<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classifica - AI Study Buddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gold-gradient: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        --silver-gradient: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
        --bronze-gradient: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        --card-bg: rgba(255, 255, 255, 0.95);
    }

    body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .sidebar {
        position: fixed;
        top: 0; left: 0;
        width: 280px; height: 100vh;
        background: rgba(26, 26, 46, 0.95);
        backdrop-filter: blur(10px);
        padding: 2rem 1rem;
        z-index: 1000;
        border-right: 1px solid rgba(255,255,255,0.1);
        transition: transform 0.3s ease;
    }

    .sidebar-header { color: white; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; }

    .sidebar-nav .nav-link {
        color: rgba(255,255,255,0.7);
        padding: 0.75rem 1rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .sidebar-nav .nav-link:hover, .sidebar-nav .nav-link.active {
        background: var(--primary-gradient);
        color: white;
    }

    .sidebar-footer { position: absolute; bottom: 2rem; left: 1rem; right: 1rem; }

    .main-content { margin-left: 280px; padding: 2rem; min-height: 100vh; }

    @media (max-width: 991.98px) {
        .sidebar { transform: translateX(-100%); }
        .sidebar.show { transform: translateX(0); }
        .main-content { margin-left: 0; padding: 1rem; padding-top: 70px; }
    }

    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
    .sidebar-overlay.show { display: block; }

    .page-header {
        background: var(--primary-gradient);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
    }

    .my-rank-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 2px solid #667eea;
    }

    .my-rank-position {
        font-size: 3rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .leaderboard-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }

    .leaderboard-tab {
        flex: 1; min-width: 120px;
        padding: 1rem; border-radius: 12px;
        background: rgba(255,255,255,0.1);
        color: white; border: none;
        cursor: pointer; transition: all 0.3s ease;
        text-align: center;
    }

    .leaderboard-tab:hover { background: rgba(255,255,255,0.2); }
    .leaderboard-tab.active { background: var(--card-bg); color: #667eea; }
    .leaderboard-tab i { font-size: 1.5rem; display: block; margin-bottom: 0.5rem; }
    .leaderboard-tab span { font-weight: 600; font-size: 0.85rem; }

    .leaderboard-card { background: var(--card-bg); border-radius: 16px; overflow: hidden; }

    .leaderboard-item {
        display: flex; align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .leaderboard-item:last-child { border-bottom: none; }
    .leaderboard-item:hover { background: #f8f9fa; }

    .leaderboard-item.current-user {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-left: 4px solid #667eea;
    }

    .leaderboard-rank {
        width: 50px; height: 50px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 1.1rem;
        margin-right: 1rem; flex-shrink: 0;
    }

    .rank-1 { background: var(--gold-gradient); color: #1a1a2e; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
    .rank-2 { background: var(--silver-gradient); color: #1a1a2e; }
    .rank-3 { background: var(--bronze-gradient); color: white; }
    .rank-other { background: #e9ecef; color: #6c757d; }

    .leaderboard-avatar {
        width: 45px; height: 45px; border-radius: 50%;
        background: var(--primary-gradient);
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 1.2rem;
        margin-right: 1rem; flex-shrink: 0;
    }

    .leaderboard-user { flex: 1; min-width: 0; }
    .leaderboard-user-name { font-weight: 600; color: #1a1a2e; }
    .leaderboard-user-level { font-size: 0.8rem; color: #6c757d; }
    .leaderboard-value { text-align: right; flex-shrink: 0; }
    .leaderboard-value-number { font-size: 1.3rem; font-weight: 700; color: #667eea; }
    .leaderboard-value-label { font-size: 0.75rem; color: #6c757d; }

    .podium-container {
        display: flex; justify-content: center; align-items: flex-end;
        gap: 1rem; margin-bottom: 2rem; padding: 1rem;
    }

    .podium-item {
        text-align: center; background: var(--card-bg);
        border-radius: 16px; padding: 1.5rem 1rem;
        transition: transform 0.3s ease; width: 140px;
    }

    .podium-item:hover { transform: translateY(-5px); }
    .podium-1 { order: 2; transform: scale(1.1); z-index: 2; border: 3px solid #ffd700; }
    .podium-2 { order: 1; }
    .podium-3 { order: 3; }

    .podium-crown { font-size: 2rem; margin-bottom: 0.5rem; }

    .podium-avatar {
        width: 70px; height: 70px; border-radius: 50%;
        margin: 0 auto 0.75rem;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.8rem;
    }

    .podium-1 .podium-avatar { background: var(--gold-gradient); width: 80px; height: 80px; }
    .podium-2 .podium-avatar { background: var(--silver-gradient); }
    .podium-3 .podium-avatar { background: var(--bronze-gradient); color: white; }

    .podium-name { font-weight: 600; font-size: 0.9rem; color: #1a1a2e; }
    .podium-value { font-weight: 700; color: #667eea; }

    .mobile-navbar {
        position: fixed; top: 0; left: 0; right: 0;
        height: 60px; background: rgba(26, 26, 46, 0.95);
        backdrop-filter: blur(10px);
        display: none; align-items: center; justify-content: space-between;
        padding: 0 1rem; z-index: 1001;
    }

    @media (max-width: 991.98px) {
        .mobile-navbar { display: flex; }
        .podium-container { flex-direction: column; align-items: center; }
        .podium-1, .podium-2, .podium-3 { order: unset; transform: none; width: 100%; max-width: 300px; }
    }
  </style>
</head>
<body>
<nav class="mobile-navbar">
  <button class="btn btn-link text-white p-0" id="mobileMenuBtn"><i class="bi bi-list fs-4"></i></button>
  <span class="text-white fw-bold">Classifica</span>
  <div style="width: 24px;"></div>
</nav>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-header"><i class="bi bi-mortarboard-fill me-2"></i><span>AI Study Buddy</span></div>
  <ul class="nav flex-column sidebar-nav">
    <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-house-door"></i> Dashboard</a></li>
    <li class="nav-item"><a class="nav-link" href="explanation.html"><i class="bi bi-lightbulb"></i> Spiegazioni</a></li>
    <li class="nav-item"><a class="nav-link" href="quiz.html"><i class="bi bi-patch-question"></i> Quiz</a></li>
    <li class="nav-item"><a class="nav-link" href="flashcards.html"><i class="bi bi-stack"></i> Flashcards</a></li>
    <li class="nav-item"><a class="nav-link" href="profilo.html"><i class="bi bi-person-circle"></i> Profilo</a></li>
    <li class="nav-item"><a class="nav-link active" href="leaderboard.html"><i class="bi bi-trophy"></i> Classifica</a></li>
  </ul>
  <div class="sidebar-footer">
    <a href="#" onclick="logout()" class="btn btn-outline-light btn-sm w-100"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
  </div>
</nav>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<main class="main-content">
  <div class="page-header">
    <h1 class="fw-bold"><i class="bi bi-trophy-fill me-2"></i>Classifica</h1>
    <p class="mb-0 opacity-75">Confrontati con gli altri studenti</p>
  </div>

  <div class="my-rank-card">
    <div class="row align-items-center">
      <div class="col-auto"><div class="my-rank-position" id="myRankPosition">#-</div></div>
      <div class="col">
        <h5 class="mb-1 text-dark">La tua posizione</h5>
        <p class="mb-0 text-muted" id="myRankDetails">Caricamento...</p>
      </div>
      <div class="col-auto text-end">
        <div class="fs-4 fw-bold text-primary" id="myXp">0 XP</div>
        <div class="small text-muted">Livello <span id="myLevel">1</span></div>
      </div>
    </div>
  </div>

  <div class="leaderboard-tabs">
    <button class="leaderboard-tab active" onclick="loadLeaderboard('XP', this)">
      <i class="bi bi-lightning-charge-fill"></i><span>XP Totali</span>
    </button>
    <button class="leaderboard-tab" onclick="loadLeaderboard('WEEKLY_XP', this)">
      <i class="bi bi-calendar-week"></i><span>Settimana</span>
    </button>
    <button class="leaderboard-tab" onclick="loadLeaderboard('STREAK', this)">
      <i class="bi bi-fire"></i><span>Streak</span>
    </button>
  </div>

  <div class="podium-container" id="podiumContainer"></div>
  <div class="leaderboard-card" id="leaderboardContainer">
    <div class="text-center py-4 text-muted">
      <div class="spinner-border spinner-border-sm"></div>
      <span class="ms-2">Caricamento...</span>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = '/api';
  let currentUserId = null;

  async function apiFetch(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      if (!token) { window.location.href = 'login.html'; return; }
      const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          ...options
      });
      if (response.status === 401 || response.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
      }
      return response;
  }

  function logout() { localStorage.removeItem('token'); window.location.href = 'login.html'; }

  document.addEventListener('DOMContentLoaded', function() {
      if (!localStorage.getItem('token')) { window.location.href = 'login.html'; return; }
      setupMobileMenu();
      loadUserInfo();
      loadLeaderboard('XP');
  });

  function setupMobileMenu() {
      const menuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      menuBtn?.addEventListener('click', () => { sidebar.classList.toggle('show'); overlay.classList.toggle('show'); });
      overlay?.addEventListener('click', () => { sidebar.classList.remove('show'); overlay.classList.remove('show'); });
  }

  async function loadUserInfo() {
      try {
          const [userResponse, statsResponse] = await Promise.all([
              apiFetch('/auth/me'),
              apiFetch('/gamification/stats')
          ]);
          if (userResponse?.ok) { const user = await userResponse.json(); currentUserId = user.id; }
          if (statsResponse?.ok) {
              const stats = await statsResponse.json();
              document.getElementById('myXp').textContent = `${(stats.totalXp || 0).toLocaleString()} XP`;
              document.getElementById('myLevel').textContent = stats.level || 1;
          }
      } catch (error) { console.error('Errore:', error); }
  }

  async function loadLeaderboard(type, btn = null) {
      if (btn) {
          document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
      }

      try {
          const [leaderboardResponse, rankResponse] = await Promise.all([
              apiFetch(`/gamification/leaderboard/${type}?limit=20`),
              apiFetch(`/gamification/leaderboard/${type}/my-rank`)
          ]);

          let entries = leaderboardResponse?.ok ? await leaderboardResponse.json() : [];
          let myRank = rankResponse?.ok ? await rankResponse.json() : -1;

          updateMyRankCard(myRank, type);
          renderPodium(entries.slice(0, 3), type);
          renderLeaderboard(entries, type);
      } catch (error) { console.error('Errore:', error); }
  }

  function updateMyRankCard(rank, type) {
      document.getElementById('myRankPosition').textContent = rank > 0 ? `#${rank}` : '#-';
      let msg = rank === 1 ? 'üèÜ Sei in testa!' : rank <= 3 ? 'ü•á Sei sul podio!' : rank <= 10 ? '‚≠ê Top 10!' : rank > 0 ? `Posizione ${rank}` : 'Non in classifica';
      document.getElementById('myRankDetails').textContent = msg;
  }

  function renderPodium(topThree, type) {
      const container = document.getElementById('podiumContainer');
      if (topThree.length < 3) { container.innerHTML = ''; return; }

      const valueLabel = type === 'STREAK' ? 'üî•' : 'XP';
      const medals = ['ü•á', 'ü•à', 'ü•â'];

      container.innerHTML = [1, 0, 2].map(idx => {
          const entry = topThree[idx];
          const pos = idx + 1;
          return `
              <div class="podium-item podium-${pos} ${entry.userId === currentUserId ? 'current-user' : ''}">
                  ${pos === 1 ? '<div class="podium-crown">üëë</div>' : ''}
                  <div class="podium-avatar">${medals[pos - 1]}</div>
                  <div class="podium-name">${entry.userName || 'Utente'}</div>
                  <div class="podium-value">${(entry.value || 0).toLocaleString()} ${valueLabel}</div>
              </div>
          `;
      }).join('');
  }

  function renderLeaderboard(entries, type) {
      const container = document.getElementById('leaderboardContainer');
      if (!entries?.length) { container.innerHTML = '<div class="text-center py-5 text-muted">Nessun dato</div>'; return; }

      const listEntries = entries.slice(3);
      const valueLabel = type === 'STREAK' ? 'giorni' : 'XP';

      container.innerHTML = listEntries.length ? listEntries.map((entry, idx) => {
          const rank = idx + 4;
          const isMe = entry.userId === currentUserId;
          return `
              <div class="leaderboard-item ${isMe ? 'current-user' : ''}">
                  <div class="leaderboard-rank rank-other">${rank}</div>
                  <div class="leaderboard-avatar"><i class="bi bi-person-fill"></i></div>
                  <div class="leaderboard-user">
                      <div class="leaderboard-user-name">${entry.userName || 'Utente'} ${isMe ? '<span class="badge bg-primary ms-1">Tu</span>' : ''}</div>
                      <div class="leaderboard-user-level">Livello ${entry.level || 1}</div>
                  </div>
                  <div class="leaderboard-value">
                      <div class="leaderboard-value-number">${(entry.value || 0).toLocaleString()}</div>
                      <div class="leaderboard-value-label">${valueLabel}</div>
                  </div>
              </div>
          `;
      }).join('') : '<div class="text-center py-4 text-muted">Solo podio disponibile</div>';
  }
</script>
</body>
</html>